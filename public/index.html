<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UDoChain BioID</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background-color: #f5f6fa;
        color: #333;
      }
      h1 {
        color: #0072ff;
      }
      button {
        background-color: #0072ff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 16px;
      }
      #log {
        margin-top: 20px;
        padding: 15px;
        width: 90%;
        max-width: 480px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: left;
        font-family: monospace;
        font-size: 14px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>üß¨ UDoChain BioID</h1>
    <p>Valida tu identidad biom√©trica antes de certificar tu documento.</p>

    <button id="btnEnroll">Registrar identidad</button>
    <button id="btnVerify">Validar identidad</button>
    <div id="log">Esperando acci√≥n del usuario...</div>

    <script>
      const apiBase = "https://bioid.udochain.com/api/webauthn";
      const log = (msg) => {
        document.getElementById("log").textContent += `\n${msg}`;
      };

      const b64ToUint8 = (base64url) =>
        Uint8Array.from(atob(base64url.replace(/-/g, "+").replace(/_/g, "/")), (c) =>
          c.charCodeAt(0)
        );

      async function enroll() {
        log("üì≤ Iniciando registro biom√©trico...");
        const start = await fetch(`${apiBase}/enroll/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "anonymous" }),
        }).then((r) => r.json());

        if (!start.ok) return log("‚ùå Error al iniciar registro");

        const options = start.options;
        options.challenge = b64ToUint8(options.challenge);
        options.user.id = b64ToUint8(options.user.id);

        const credential = await navigator.credentials.create({ publicKey: options });

        const attResp = {
          id: credential.id,
          rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
          type: credential.type,
          response: {
            attestationObject: btoa(
              String.fromCharCode(...new Uint8Array(credential.response.attestationObject))
            ),
            clientDataJSON: btoa(
              String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))
            ),
          },
        };

        const finish = await fetch(`${apiBase}/enroll/finish`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "anonymous", attResp }),
        }).then((r) => r.json());

        if (finish.ok) log("‚úÖ Registro completado correctamente");
        else log(`‚ùå Error: ${finish.error}`);
      }

      async function verify() {
        log("üîê Iniciando verificaci√≥n biom√©trica...");
        const start = await fetch(`${apiBase}/verify/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "anonymous" }),
        }).then((r) => r.json());

        if (!start.ok) return log("‚ùå Error al iniciar verificaci√≥n");

        const options = start.options;
        options.challenge = b64ToUint8(options.challenge);

        const credential = await navigator.credentials.get({ publicKey: options });

        const authResp = {
          id: credential.id,
          rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
          type: credential.type,
          response: {
            authenticatorData: btoa(
              String.fromCharCode(...new Uint8Array(credential.response.authenticatorData))
            ),
            clientDataJSON: btoa(
              String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))
            ),
            signature: btoa(
              String.fromCharCode(...new Uint8Array(credential.response.signature))
            ),
            userHandle: credential.response.userHandle
              ? btoa(String.fromCharCode(...new Uint8Array(credential.response.userHandle)))
              : null,
          },
        };

        const finish = await fetch(`${apiBase}/verify/finish`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "anonymous", authResp }),
        }).then((r) => r.json());

        if (finish.ok) {
          log(`‚úÖ Identidad verificada con hash: ${finish.hash}`);
          window.location.href = `https://validate.udochain.com/?bioidHash=${finish.hash}`;
        } else {
          log(`‚ùå Error: ${finish.error}`);
        }
      }

      document.getElementById("btnEnroll").onclick = enroll;
      document.getElementById("btnVerify").onclick = verify;
    </script>
  </body>
</html>
