<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UDoChain BioID Authentication</title>
  </head>
  <body
    style="
      font-family: sans-serif;
      padding: 40px;
      background-color: #f5f7fb;
      color: #222;
    "
  >
    <h1>üîê UDoChain BioID</h1>
    <p>Autenticaci√≥n biom√©trica con WebAuthn (Touch ID / Face ID / FIDO2)</p>

    <input
      type="text"
      id="userId"
      placeholder="User ID (ej: claudio1)"
      value="claudio1"
    />
    <br /><br />

    <button onclick="register()">üß¨ Registrar biometr√≠a</button>
    <button onclick="verify()">‚úÖ Verificar identidad</button>

    <pre id="output" style="margin-top:20px;background:#eee;padding:10px;"></pre>

    <script>
      async function register() {
        const userId = document.getElementById("userId").value.trim();
        const out = document.getElementById("output");
        out.textContent = "Registrando...";

        // Paso 1: obtener opciones
        const resStart = await fetch("/api/webauthn/enroll/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId }),
        });
        const data = await resStart.json();

        // Paso 2: crear credencial biom√©trica real
        const attResp = await navigator.credentials.create({
          publicKey: data.options,
        });

        // Paso 3: enviar al servidor
        const resFinish = await fetch("/api/webauthn/enroll/finish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, attResp }),
        });

        const done = await resFinish.json();
        out.textContent = JSON.stringify(done, null, 2);
      }

      async function verify() {
        const userId = document.getElementById("userId").value.trim();
        const out = document.getElementById("output");
        out.textContent = "Verificando...";

        // Paso 1: challenge de verificaci√≥n
        const resStart = await fetch("/api/webauthn/verify/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId }),
        });
        const data = await resStart.json();

        // Paso 2: solicitar autenticaci√≥n real al dispositivo
        const authResp = await navigator.credentials.get({
          publicKey: data.options,
        });

        // Paso 3: enviar autenticaci√≥n al servidor
        const resFinish = await fetch("/api/webauthn/verify/finish", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, authResp }),
        });

        const done = await resFinish.json();
        out.textContent = JSON.stringify(done, null, 2);
      }
    </script>
  </body>
</html>
