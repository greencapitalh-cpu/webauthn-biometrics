<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UDoChain BioID</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background-color: #f5f6fa;
        color: #333;
      }
      h1 {
        color: #0072ff;
      }
      button {
        background-color: #0072ff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 16px;
      }
      button:hover {
        background-color: #005fd1;
      }
      #log {
        margin-top: 20px;
        padding: 15px;
        width: 90%;
        max-width: 480px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        text-align: left;
        font-family: monospace;
        font-size: 14px;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <h1>üß¨ UDoChain BioID</h1>
    <p>Valida tu identidad biom√©trica antes de certificar tu documento.</p>

    <button id="btnEnroll">Registrar identidad</button>
    <button id="btnVerify">Validar identidad</button>

    <div id="log">Esperando acci√≥n del usuario...</div>

    <script>
      const log = (msg) => {
        const el = document.getElementById("log");
        el.textContent += `\n${msg}`;
      };

      const apiBase = "https://bioid.udochain.com/api/webauthn";

      // --- REGISTRO (solo la primera vez) ---
      async function enroll() {
        log("üì≤ Iniciando registro biom√©trico...");

        const start = await fetch(`${apiBase}/enroll/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "anonymous", userName: "Usuario BioID" }),
        }).then((r) => r.json());

        if (!start.ok) {
          log("‚ùå Error al iniciar registro");
          return;
        }

        const options = start.options;
        options.challenge = Uint8Array.from(atob(options.challenge), (c) => c.charCodeAt(0));
        options.user.id = Uint8Array.from(options.user.id.data || [1, 2, 3]);

        const credential = await navigator.credentials.create({ publicKey: options });
        const attResp = {
          id: credential.id,
          rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
          type: credential.type,
          response: {
            attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject))),
            clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))),
          },
        };

        const finish = await fetch(`${apiBase}/enroll/finish`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "anonymous", attResp }),
        }).then((r) => r.json());

        if (finish.ok) log("‚úÖ Registro biom√©trico completado correctamente");
        else log(`‚ùå Error en registro: ${finish.error}`);
      }

      // --- VERIFICACI√ìN (flujo de validaci√≥n real) ---
      async function verify() {
        log("üîê Iniciando verificaci√≥n biom√©trica...");

        const start = await fetch(`${apiBase}/verify/start`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "anonymous" }),
        }).then((r) => r.json());

        if (!start.ok) {
          log("‚ùå Error al iniciar verificaci√≥n");
          return;
        }

        const options = start.options;
        options.challenge = Uint8Array.from(atob(options.challenge), (c) => c.charCodeAt(0));

        const credential = await navigator.credentials.get({ publicKey: options });

        const authResp = {
          id: credential.id,
          rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
          type: credential.type,
          response: {
            authenticatorData: btoa(String.fromCharCode(...new Uint8Array(credential.response.authenticatorData))),
            clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))),
            signature: btoa(String.fromCharCode(...new Uint8Array(credential.response.signature))),
            userHandle: credential.response.userHandle
              ? btoa(String.fromCharCode(...new Uint8Array(credential.response.userHandle)))
              : null,
          },
        };

        const finish = await fetch(`${apiBase}/verify/finish`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: "anonymous", authResp }),
        }).then((r) => r.json());

        if (finish.ok) {
          log(`‚úÖ Identidad verificada con hash: ${finish.hash}`);

          // --- Enviar hash a Validate (frontend de validate.udochain.com) ---
          const redirectUrl = `https://validate.udochain.com/?bioidHash=${finish.hash}`;
          log(`‚û°Ô∏è Redirigiendo a: ${redirectUrl}`);
          window.location.href = redirectUrl;
        } else {
          log(`‚ùå Error en verificaci√≥n: ${finish.error}`);
        }
      }

      document.getElementById("btnEnroll").addEventListener("click", enroll);
      document.getElementById("btnVerify").addEventListener("click", verify);
    </script>
  </body>
</html>
